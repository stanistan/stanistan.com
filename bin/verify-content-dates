#!/bin/bash
#
# This script looks for all of the "posts"
# in the $WRITES_DIR and makes sure they're
# in the correct place wrt date formats.
#
# It also removes all directories that don't have
# anything but empty/missing sections.
#
# The script must be called from the root directory.
set -e

source "bin/inc.sh"

WRITES_DIR=content/writes
DIR_INDEX=_index.md
PATH_TO_SECION_INDEX="templates/writes_section"

[ ! -d "$WRITES_DIR" ] &&
    err "No $WRITES_DIR in current directory" &&
    exit 1

find_non_index_files() {
    find "$(dirname "$1")" -name "*.md" | grep -v "$DIR_INDEX" || true
}

link_section_file() {
    if [ ! -d "$2" ]; then
        mkdir "$2"
    fi

    if [ ! -f "$2/$DIR_INDEX" ]; then
        ln -s "$1/$PATH_TO_SECION_INDEX" "$2/$DIR_INDEX"
        echo "Linked file: $2/$DIR_INDEX"
    fi
}

ensure_directories_exist() {
    local DIR_PATH="$WRITES_DIR"
    local UP_PATH="../.."
    local DATE_PATH

    DATE_PATH="$1"
    IFS='/'
    read -ra DIRS <<< "$DATE_PATH"
    for DIR in "${DIRS[@]}"; do
        DIR_PATH="$DIR_PATH/$DIR"
        UP_PATH="$UP_PATH/.."
        link_section_file "$UP_PATH" "$DIR_PATH"
    done
}

check_writes_post() {
    local FILE_PATH             # first input arg
    local FILE_NAME             # the tail of the path we're going to be receiving
    local PARSED_DATE           # the parsed out date value from the file, unformatted
    local PARSED_DATE_FORMATTED # the parsed date value, formatted
    local NEW_FILE_PATH         # the file we're going to be moving this to

    FILE_PATH="$1"
    FILE_NAME="${FILE_PATH##*/}"
    PARSED_DATE=$(awk '/^date = [0-9-]+$/{print $3}' "$FILE_PATH")
    PARSED_DATE_FORMATTED=${PARSED_DATE//-/"/"}
    NEW_FILE_PATH="$WRITES_DIR/$PARSED_DATE_FORMATTED/$FILE_NAME"

    ensure_directories_exist "$PARSED_DATE_FORMATTED"
    mv "$FILE_PATH" "$NEW_FILE_PATH"
}

check_index_file() {
    local FOUND
    FOUND="$(find_non_index_files "$1")"
    if [ -z "$FOUND" ]; then
        echo "Removed: $1"
        rm "$1"
    fi
}

for_each_writes_post() {
    while read -r FILE_PATH; do
        check_writes_post "$FILE_PATH"
    done
}

for_each_index_file() {
    while read -r FILE_PATH; do
        check_index_file "$FILE_PATH"
    done
}

# Find all the markdown files in the $WRITES_DIR
# that aren't `_index.md` and make sure they're in
# the correct directory.
find "$WRITES_DIR" -name "*.md" | grep -v "$DIR_INDEX" | for_each_writes_post

# Remove all the _index.md files that have no associated posts.
find $WRITES_DIR -name "$DIR_INDEX" | for_each_index_file

# Remove all empty directories.
find $WRITES_DIR -type d -empty -delete
